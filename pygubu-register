#!/usr/bin/env python3
"""Register and manage pygubu projects globally"""
import sys
import json
import pathlib
from datetime import datetime

REGISTRY = pathlib.Path.home() / ".pygubu-registry.json"

def load_registry():
    if REGISTRY.exists():
        return json.loads(REGISTRY.read_text())
    return {"projects": {}, "active_project": None, "last_updated": None}

def save_registry(data):
    data["last_updated"] = datetime.now().isoformat()
    REGISTRY.write_text(json.dumps(data, indent=2))

def register_project(path):
    """Register a pygubu project"""
    project_path = pathlib.Path(path).resolve()
    if not project_path.exists():
        print(f"Error: {path} not found")
        return
    
    # Find .ui files
    ui_files = list(project_path.glob("*.ui"))
    if not ui_files:
        print(f"No .ui files found in {path}")
        return
    
    registry = load_registry()
    project_name = project_path.name
    
    registry["projects"][project_name] = {
        "path": str(project_path),
        "ui_files": [str(f) for f in ui_files],
        "py_files": [str(f) for f in project_path.glob("*.py")],
        "registered": datetime.now().isoformat()
    }
    
    save_registry(registry)
    print(f"‚úì Registered: {project_name}")
    print(f"  Path: {project_path}")
    print(f"  UI files: {len(ui_files)}")

def set_active(project_name):
    """Set active project"""
    registry = load_registry()
    if project_name not in registry["projects"]:
        print(f"Project '{project_name}' not registered")
        print(f"Available: {', '.join(registry['projects'].keys())}")
        return
    
    registry["active_project"] = project_name
    save_registry(registry)
    print(f"‚úì Active project: {project_name}")

def list_projects():
    """List all registered projects"""
    registry = load_registry()
    if not registry["projects"]:
        print("No projects registered")
        print("\nRegister a project:")
        print("  pygubu-register add /path/to/project")
        return
    
    print("üìÅ Registered Pygubu Projects:\n")
    for name, info in registry["projects"].items():
        active = " ‚≠ê" if name == registry["active_project"] else ""
        print(f"  {name}{active}")
        print(f"    Path: {info['path']}")
        print(f"    UI files: {len(info['ui_files'])}")
        print()

def get_active():
    """Get active project info"""
    registry = load_registry()
    if not registry["active_project"]:
        print("No active project")
        return None
    
    project = registry["projects"].get(registry["active_project"])
    if project:
        print(json.dumps({
            "name": registry["active_project"],
            **project
        }, indent=2))
    return project

def scan_directory(directory="."):
    """Auto-scan directory for pygubu projects"""
    base = pathlib.Path(directory).resolve()
    found = []
    
    for item in base.rglob("*.ui"):
        project_dir = item.parent
        if project_dir not in found:
            found.append(project_dir)
    
    if not found:
        print(f"No pygubu projects found in {directory}")
        return
    
    print(f"Found {len(found)} project(s):\n")
    registry = load_registry()
    
    for proj_dir in found:
        name = proj_dir.name
        print(f"  {name} - {proj_dir}")
        registry["projects"][name] = {
            "path": str(proj_dir),
            "ui_files": [str(f) for f in proj_dir.glob("*.ui")],
            "py_files": [str(f) for f in proj_dir.glob("*.py")],
            "registered": datetime.now().isoformat()
        }
    
    save_registry(registry)
    print(f"\n‚úì Registered {len(found)} project(s)")

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("Pygubu Project Registry")
        print("\nCommands:")
        print("  add <path>      - Register a project")
        print("  active <name>   - Set active project")
        print("  list            - List all projects")
        print("  info            - Show active project")
        print("  scan [dir]      - Auto-scan for projects")
        print("\nExamples:")
        print("  pygubu-register add ~/number_game")
        print("  pygubu-register active number_game")
        print("  pygubu-register scan ~/projects")
        sys.exit(1)
    
    cmd = sys.argv[1]
    
    if cmd == "add" and len(sys.argv) == 3:
        register_project(sys.argv[2])
    elif cmd == "active" and len(sys.argv) == 3:
        set_active(sys.argv[2])
    elif cmd == "list":
        list_projects()
    elif cmd == "info":
        get_active()
    elif cmd == "scan":
        directory = sys.argv[2] if len(sys.argv) == 3 else "."
        scan_directory(directory)
    else:
        print("Invalid command")
        sys.exit(1)
