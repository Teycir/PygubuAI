#!/usr/bin/env python3
"""Watch pygubu projects for UI changes and sync with code"""
import sys
import json
import time
import pathlib
import hashlib
from datetime import datetime

def get_file_hash(filepath):
    """Get MD5 hash of file"""
    return hashlib.md5(pathlib.Path(filepath).read_bytes()).hexdigest()

def load_workflow(project_path):
    """Load workflow tracking file"""
    workflow_file = project_path / ".pygubu-workflow.json"
    if workflow_file.exists():
        return json.loads(workflow_file.read_text())
    return {"ui_hash": None, "last_sync": None, "changes": []}

def save_workflow(project_path, data):
    """Save workflow tracking"""
    workflow_file = project_path / ".pygubu-workflow.json"
    data["last_sync"] = datetime.now().isoformat()
    workflow_file.write_text(json.dumps(data, indent=2))

def watch_project(project_name):
    """Watch project for UI changes"""
    # Load registry
    registry_file = pathlib.Path.home() / ".pygubu-registry.json"
    if not registry_file.exists():
        print("No projects registered. Run: pygubu-register scan")
        return
    
    registry = json.loads(registry_file.read_text())
    
    if project_name not in registry["projects"]:
        print(f"Project '{project_name}' not found")
        print(f"Available: {', '.join(registry['projects'].keys())}")
        return
    
    project_info = registry["projects"][project_name]
    project_path = pathlib.Path(project_info["path"])
    ui_files = [pathlib.Path(f) for f in project_info["ui_files"]]
    
    if not ui_files:
        print(f"No .ui files in {project_name}")
        return
    
    print(f"üëÅÔ∏è  Watching {project_name}...")
    print(f"   Path: {project_path}")
    print(f"   UI files: {len(ui_files)}")
    print("\nPress Ctrl+C to stop\n")
    
    workflow = load_workflow(project_path)
    
    try:
        while True:
            for ui_file in ui_files:
                if not ui_file.exists():
                    continue
                
                current_hash = get_file_hash(ui_file)
                
                if workflow["ui_hash"] is None:
                    workflow["ui_hash"] = current_hash
                    save_workflow(project_path, workflow)
                elif current_hash != workflow["ui_hash"]:
                    print(f"üîÑ UI changed: {ui_file.name}")
                    print(f"   Time: {datetime.now().strftime('%H:%M:%S')}")
                    print("\nüí° Suggested action:")
                    print(f"   Tell your AI: 'I updated {ui_file.name}, sync the Python code'")
                    print(f"   Or: 'Review changes in {project_name}'\n")
                    
                    workflow["ui_hash"] = current_hash
                    workflow["changes"].append({
                        "file": str(ui_file),
                        "timestamp": datetime.now().isoformat()
                    })
                    save_workflow(project_path, workflow)
            
            time.sleep(2)
    
    except KeyboardInterrupt:
        print("\n\n‚úì Stopped watching")

if __name__ == '__main__':
    if len(sys.argv) < 3 or sys.argv[1] != "watch":
        print("Usage: pygubu-ai-workflow watch <project_name>")
        print("\nExample:")
        print("  pygubu-ai-workflow watch myapp")
        print("\nThis monitors .ui file changes and suggests AI sync actions")
        sys.exit(1)
    
    watch_project(sys.argv[2])
